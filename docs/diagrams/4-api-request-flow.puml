@startuml
title API Request Flow - CRM Service
!pragma layout smetana
!theme plain

actor Client
participant "LeadController" as Controller
participant "CreateLeadHandler" as CreateHandler
participant "GetLeadHandler" as GetHandler
participant "LeadFactory" as Factory
participant "CreateLeadService" as CreateService
participant "GetLeadService" as GetService
database "LeadRepository" as LeadRepo
participant "LeadTransformer" as Transformer

== POST /api/v1/leads ==

Client -> Controller : POST /api/v1/leads\n(JSON body)
Controller -> CreateHandler : createBulk(CreateLeadCollectionDto)
CreateHandler -> Factory : Build Lead entities
Factory --> CreateHandler : Lead[]
CreateHandler -> CreateService : createLeads(Lead[])
CreateService -> LeadRepo : add() + flush()
LeadRepo --> CreateService : persisted leads
CreateService --> CreateHandler : created leads
CreateHandler -> Transformer : transformCollection($leads)
Transformer --> CreateHandler : transformed data
CreateHandler --> Controller : ApiResponse(201 Created)
Controller --> Client : JSON Response (created leads)

== GET /api/v1/leads?include=contacts ==

Client -> Controller : GET /api/v1/leads?include=contacts
Controller -> GetHandler : getList(GetLeadQueryDto)
GetHandler -> GetService : getLeadsByAccount(LeadSearchCriteria)
GetService -> LeadRepo : findByAccountId($criteria)\n(with joins if `with` includes contacts)
LeadRepo --> GetService : list of leads\n(+ contacts if joined)
GetService --> GetHandler : leads (with contacts loaded)
GetHandler -> Transformer : transformCollection($leads, $criteria->getWith())
Transformer --> GetHandler : transformed DTOs
GetHandler --> Controller : ApiResponse(200 OK)
Controller --> Client : JSON Response (leads with contacts)

@enduml
